<!doctype html>
<html lang="en-CA">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Quote Request</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
      :root { --primary:#0d6efd; --secondary:#0d1117; --danger:#dc3545; --success:#198754; --border:#ddd; --muted:#6c757d; }
      body { font-family: system-ui,-apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial; margin:0; padding:0; color:#222; background:#fafafa; }
      header { background: linear-gradient(135deg, var(--secondary), var(--primary)); color:#fff; }
      .topbar { max-width: 1200px; margin: 0 auto; display:flex; align-items:center; justify-content:space-between; gap:.75rem; padding:.75rem 1rem; }
      .brand { font-weight:700; letter-spacing:.05em; }
      .home-btn { display:inline-flex; align-items:center; justify-content:center; gap:.4rem; padding:.5rem .9rem; border-radius:999px; background:#ffffff; color:var(--secondary); font-weight:700; text-decoration:none; border:2px solid rgba(255,255,255,.7); box-shadow:0 8px 18px rgba(2,8,23,.25); transition: transform .2s ease, box-shadow .2s ease, background .2s ease; white-space:nowrap; }
      .home-btn:hover { transform: translateY(-1px); box-shadow: 0 12px 26px rgba(2,8,23,.32); }
      .home-btn:active { transform: translateY(0); }
      .home-btn:focus-visible { outline: 3px solid rgba(255,255,255,.85); outline-offset: 2px; }
      .container { max-width:980px; margin:24px auto; padding:16px; background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.04); }
      h1 { margin:0 0 16px; font-size:1.6rem; }
      form { display:grid; gap:16px; }
      .row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
      label { display:block; font-weight:600; margin-bottom:6px; }
      input[type="text"], input[type="tel"], textarea { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px; font-size:1rem; box-sizing:border-box; }
      textarea { min-height:120px; resize:vertical; }
      .muted { color:var(--muted); font-size:.9rem; }
      .counter { text-align:right; font-size:.85rem; color:var(--muted); }
      .upload-box { border:1px dashed var(--border); border-radius:10px; padding:12px; background:#fcfcfc; }
      .thumbs { display:grid; grid-template-columns:repeat(auto-fill, minmax(120px, 1fr)); gap:10px; margin-top:12px; }
      .thumb { position:relative; border:1px solid var(--border); border-radius:8px; overflow:hidden; background:#fff; }
      .thumb img { display:block; width:100%; height:100px; object-fit:cover; }
      .thumb button.remove { position:absolute; top:6px; right:6px; width:24px; height:24px; border:none; border-radius:50%; background:rgba(220,53,69,.95); color:#fff; font-weight:700; cursor:pointer; }
      .map-wrap { border:1px solid var(--border); border-radius:10px; overflow:hidden; background:#fcfcfc; }
      #map { height:360px; }
      .map-toolbar { display:flex; flex-wrap:wrap; gap:8px; align-items:center; padding:10px; border-top:1px solid var(--border); background:#fff; }
      .map-toolbar .grow { flex:1; }
      .map-toolbar input[type="text"] { height:38px; }
      .btn { height:38px; padding:0 14px; border:1px solid var(--border); border-radius:8px; background:#fff; cursor:pointer; }
      .btn.primary { background:var(--primary); color:#fff; border-color:var(--primary); }
      .btn.ghost { background:#fff; }
      .btn:disabled { opacity:.6; cursor:default; }
      .radius { display:flex; align-items:center; gap:12px; }
      .status { font-size:.95rem; }
      .status.success { color:var(--success); }
      .status.error { color:var(--danger); }
      @media (max-width:720px){ .row{ grid-template-columns:1fr; } #map{ height:300px; } }

      /* Back-to-top button */
      .back-to-top { position: fixed; bottom: 1.25rem; right: 1.25rem; width: 52px; height: 52px; border-radius: 999px; background: var(--primary); color:#fff; border:none; display:grid; place-items:center; font-size:20px; box-shadow:0 10px 24px rgba(2,8,23,.25); z-index:60; opacity:0; pointer-events:none; transform: translateY(8px); transition: opacity .25s ease, transform .25s ease, box-shadow .25s ease; }
      .back-to-top.show { opacity: 1; pointer-events: auto; transform: translateY(0); }
      .back-to-top:hover { box-shadow: 0 14px 30px rgba(2,8,23,.32); }
      .back-to-top:focus-visible { outline: 3px solid rgba(255,255,255,.6); outline-offset: 2px; }
    </style>
  </head>
  <body>
    <header>
      <div class="topbar">
        <div class="brand">NCR Construction — Quote</div>
        <a href="index.html" class="home-btn" aria-label="Go to Home" title="Home">Home</a>
      </div>
    </header>
    <div class="container">
      <h1>Quote Request</h1>
      <p class="muted">Please complete all required fields. Selecting a region on the map is recommended to help estimate faster. Address is optional.</p>

      <form id="quoteForm" action="https://formsubmit.co/novais.marcos.usa@gmail.com" method="POST" enctype="multipart/form-data" novalidate>
        <div class="row">
          <div>
            <label for="name">Full name</label>
            <input id="name" name="name" type="text" required placeholder="Your name" />
          </div>
          <div>
            <label for="phone">Phone</label>
            <input id="phone" name="phone" type="tel" required placeholder="(###) ###-####" pattern="^[+()\d\s-]{8,20}$" />
          </div>
        </div>

        <div>
          <label for="jobTitle">What is the job?</label>
          <input id="jobTitle" name="jobTitle" type="text" required placeholder="e.g., Exterior house painting" />
        </div>

        <div>
          <label for="details">Job details (up to 500 characters)</label>
          <textarea id="details" name="details" maxlength="500" required placeholder="Describe materials, dimensions, timelines, special notes, etc."></textarea>
          <div class="counter"><span id="detailsCount">0</span>/500</div>
        </div>

        <div class="upload-box">
          <label for="images">Images (optional)</label>
          <input id="images" name="images" type="file" accept="image/*" multiple />
          <div class="muted">Preview below. Click “X” to remove any image.</div>
          <div id="thumbs" class="thumbs"></div>
        </div>

        <div>
          <label for="addressText">Address (optional)</label>
          <input id="addressText" name="addressText" type="text" placeholder="Street address, city, province/state" />
          <div class="muted">Optional: you can leave this blank if you prefer not to share your exact address. Selecting a region on the map below is sufficient.</div>
        </div>

        <div class="map-wrap">
          <div id="map"></div>
          <div class="map-toolbar">
            <button type="button" id="btnGps" class="btn ghost">Use my location (GPS)</button>
            <div class="radius">
              <label for="radius">Proximity:</label>
              <input id="radius" type="range" min="100" max="50000" step="100" value="1000" />
              <span id="radiusLabel" class="muted">1000 m</span>
            </div>
            <input id="searchAddress" class="grow" type="text" placeholder="Search the map for an address" />
            <button type="button" id="btnSearch" class="btn">Search</button>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="city">City</label>
            <input id="city" name="city" type="text" placeholder="Detected from map" />
          </div>
          <div>
            <label for="area">Neighbourhood/Area</label>
            <input id="area" name="area" type="text" placeholder="Detected from map" />
          </div>
        </div>
        <input id="lat" name="lat" type="hidden" />
        <input id="lng" name="lng" type="hidden" />
        <input id="radiusMeters" name="radiusMeters" type="hidden" value="1000" />
        <input id="_next" name="_next" type="hidden" />
        <input id="_subject" name="_subject" type="hidden" />

        <div>
          <button id="submitBtn" type="submit" class="btn primary">Send quote request</button>
          <a href="index.html" class="btn ghost" style="margin-left:8px">Back to Home</a>
          <span id="formStatus" class="status" aria-live="polite"></span>
        </div>
      </form>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
      (function(){
        const details = document.getElementById('details');
        const detailsCount = document.getElementById('detailsCount');
        const imagesInput = document.getElementById('images');
        const thumbs = document.getElementById('thumbs');
        const radiusRange = document.getElementById('radius');
        const radiusLabel = document.getElementById('radiusLabel');
        const addressText = document.getElementById('addressText');
        const searchAddress = document.getElementById('searchAddress');
        const btnSearch = document.getElementById('btnSearch');
        const btnGps = document.getElementById('btnGps');
        const cityInput = document.getElementById('city');
        const areaInput = document.getElementById('area');
        const latInput = document.getElementById('lat');
        const lngInput = document.getElementById('lng');
        const radiusMetersInput = document.getElementById('radiusMeters');
        const form = document.getElementById('quoteForm');
        const submitBtn = document.getElementById('submitBtn');
        const formStatus = document.getElementById('formStatus');

        // Counter
        const updateCounter = () => { detailsCount.textContent = details.value.length; };
        details.addEventListener('input', updateCounter); updateCounter();

        // Image preview and removal
        let selectedFiles = [];
        const MAX_IMAGES = 12;
        function refreshInputFiles(){ const dt = new DataTransfer(); selectedFiles.forEach(f => dt.items.add(f)); imagesInput.files = dt.files; }
        function renderThumbs(){
          thumbs.innerHTML = '';
          selectedFiles.forEach((file, idx) => {
            const url = URL.createObjectURL(file);
            const item = document.createElement('div'); item.className = 'thumb';
            const img = document.createElement('img'); img.src = url; img.alt = file.name;
            const btn = document.createElement('button'); btn.type = 'button'; btn.className = 'remove'; btn.title = 'Remove image'; btn.textContent = 'X';
            btn.addEventListener('click', () => { selectedFiles.splice(idx,1); refreshInputFiles(); renderThumbs(); URL.revokeObjectURL(url); });
            item.appendChild(img); item.appendChild(btn); thumbs.appendChild(item);
          });
        }
        imagesInput.addEventListener('change', () => { const files = Array.from(imagesInput.files||[]); for(const f of files){ if(!f.type.startsWith('image/')) continue; if(selectedFiles.length>=MAX_IMAGES) break; selectedFiles.push(f); } refreshInputFiles(); renderThumbs(); imagesInput.value=''; });

        // Leaflet map
        const map = L.map('map');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'&copy; OpenStreetMap contributors' }).addTo(map);
        map.setView([56.1304, -106.3468], 4);
        let centerMarker = null; let regionCircle = null;
        function setRegion(lat,lng){ const radius = Number(radiusRange.value); radiusMetersInput.value=String(radius); latInput.value=String(lat); lngInput.value=String(lng);
          if(!centerMarker){ centerMarker = L.marker([lat,lng], { draggable:true }).addTo(map); centerMarker.on('dragend',()=>{ const p=centerMarker.getLatLng(); setRegion(p.lat,p.lng); updateCityArea(p.lat,p.lng); }); }
          else { centerMarker.setLatLng([lat,lng]); }
          if(!regionCircle){ regionCircle = L.circle([lat,lng], { radius, color:'#0d6efd', fillOpacity:0.1 }).addTo(map); }
          else { regionCircle.setLatLng([lat,lng]); regionCircle.setRadius(radius); }
        }
        function hasRegionSelected(){ return !!(centerMarker && regionCircle); }
        function formatRadiusLabel(v){ const n=Number(v); return n>=1000 ? (n/1000).toFixed(n%1000===0?0:1)+' km' : n+' m'; }
        radiusLabel.textContent = formatRadiusLabel(radiusRange.value);
        radiusRange.addEventListener('input', ()=>{ radiusLabel.textContent = formatRadiusLabel(radiusRange.value); if(hasRegionSelected()) { const p=centerMarker.getLatLng(); setRegion(p.lat,p.lng);} });
        map.on('click', (e)=>{ setRegion(e.latlng.lat,e.latlng.lng); map.flyTo([e.latlng.lat,e.latlng.lng], Math.max(map.getZoom(),14)); updateCityArea(e.latlng.lat,e.latlng.lng); });
        btnGps.addEventListener('click', ()=>{ if(!navigator.geolocation){ alert('Geolocation is not supported by your browser.'); return; } btnGps.disabled=true; navigator.geolocation.getCurrentPosition((pos)=>{ const {latitude,longitude}=pos.coords; setRegion(latitude,longitude); map.flyTo([latitude,longitude],15); updateCityArea(latitude,longitude); btnGps.disabled=false; },()=>{ alert('Could not get your location.'); btnGps.disabled=false; },{enableHighAccuracy:true, maximumAge:30000, timeout:15000}); });

        async function geocodeAddress(q){ const url=new URL('https://nominatim.openstreetmap.org/search'); url.searchParams.set('format','json'); url.searchParams.set('limit','1'); url.searchParams.set('q',q); url.searchParams.set('countrycodes','ca'); url.searchParams.set('email','novais.marcos.usa@gmail.com'); const res = await fetch(url.toString(), { headers:{Accept:'application/json'} }); if(!res.ok) throw new Error('Failed to search address'); const data = await res.json(); if(!data||!data.length) return null; return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon), display: data[0].display_name } }
        async function reverseGeocode(lat,lon){ const url=new URL('https://nominatim.openstreetmap.org/reverse'); url.searchParams.set('format','json'); url.searchParams.set('lat',String(lat)); url.searchParams.set('lon',String(lon)); url.searchParams.set('zoom','15'); url.searchParams.set('addressdetails','1'); url.searchParams.set('email','novais.marcos.usa@gmail.com'); const res = await fetch(url.toString(), { headers:{Accept:'application/json'} }); if(!res.ok) return null; const data = await res.json(); return data && data.address ? data.address : null }
        async function updateCityArea(lat,lon){ try{ const addr = await reverseGeocode(lat,lon); if(!addr) return; const cidade = addr.city || addr.town || addr.village || addr.municipality || ''; const bairro = addr.suburb || addr.neighbourhood || addr.city_district || ''; if(cidade && !cityInput.value) cityInput.value=cidade; if(bairro && !areaInput.value) areaInput.value=bairro; } catch{} }
        btnSearch.addEventListener('click', async ()=>{ const q=searchAddress.value.trim(); if(!q) return; btnSearch.disabled=true; try{ const res = await geocodeAddress(q); if(res){ setRegion(res.lat,res.lon); map.flyTo([res.lat,res.lon],15); addressText.value=res.display; updateCityArea(res.lat,res.lon); } else { alert('Address not found.'); } } catch{ alert('Failed to search for address.'); } finally{ btnSearch.disabled=false; } });

        // Submit
        form.addEventListener('submit', (e)=>{
          e.preventDefault();
          formStatus.textContent = '';
          const requiredIds=['name','phone','jobTitle','details'];
          for(const id of requiredIds){ const el=document.getElementById(id); if(!el.value.trim()){ el.focus(); formStatus.textContent='Please fill out all required fields.'; formStatus.className='status error'; return; } }
          const nameVal=document.getElementById('name').value.trim();
          const jobVal=document.getElementById('jobTitle').value.trim();
          document.getElementById('_subject').value = `Quote: ${jobVal} - ${nameVal}`;
          document.getElementById('_next').value = new URL('thanks.html', window.location.href).href;
          submitBtn.disabled=true; submitBtn.textContent='Sending...';
          form.submit();
        });
      })();
    </script>
    <button id="backToTop" class="back-to-top" aria-label="Back to top" title="Back to top">↑</button>
    <script>
      (function(){
        const btn = document.getElementById('backToTop');
        function toggle(){ const show = window.scrollY > 400; btn.classList.toggle('show', show); }
        window.addEventListener('scroll', toggle, { passive: true });
        document.addEventListener('DOMContentLoaded', toggle);
        btn.addEventListener('click', (e)=>{ e.preventDefault(); window.scrollTo({ top: 0, behavior: 'smooth' }); });
      })();
    </script>
  </body>
  </html>
