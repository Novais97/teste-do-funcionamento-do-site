<!DOCTYPE html>
<html lang="en-CA">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gallery - NCR Construction</title>
  <style>
    :root {
      --primary: #1f6feb;
      --secondary: #0d1117;
      --bg: #f6f8fa;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #475569;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 40;
      background: linear-gradient(135deg, var(--secondary), var(--primary));
      color: #fff;
      padding: .75rem 1rem;
      box-shadow: 0 6px 18px rgba(0,0,0,0.2);
    }
    .topbar {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .75rem;
      flex-wrap: wrap;
    }
    .brand { font-weight: 700; letter-spacing: .05em; }
    .toc { display: flex; gap: .5rem; flex-wrap: wrap; }
    .toc a {
      color: #fff; text-decoration: none; opacity: .9;
      padding: .25rem .6rem; border: 1px solid rgba(255,255,255,.3);
      border-radius: 999px; font-size: .9rem;
    }
    .toc a:hover { opacity: 1; border-color: #fff; }

    html { scroll-behavior: smooth; }
    main { scroll-behavior: smooth; }
    section {
      min-height: 88vh;
      padding: .5rem 0 1rem;
      scroll-margin-top: 64px;
    }
    .wrap { max-width: 1400px; margin: 0 auto; }
    .section-head { margin: 0 1rem .5rem; }
    .section-title { font-size: 1.25rem; margin: 0 0 .1rem; color: var(--secondary); }
    .section-sub { color: var(--muted); margin: 0; font-size: .95rem; }

    /* Horizontal gallery strip */
    .strip {
      position: relative;
      background: var(--card);
      border-radius: 0;
      box-shadow: 0 10px 26px rgba(2, 8, 23, .08);
      padding: 0 4rem 3px; /* space for arrows */
    }
    .strip__scroller {
      display: flex;
      gap: .5rem;
      overflow-x: auto;
      overflow-y: hidden;
      scroll-snap-type: x mandatory;
      scroll-behavior: smooth;
      overscroll-behavior-x: contain;
      -webkit-overflow-scrolling: touch;
      align-items: stretch;
    }
    .card {
      position: relative;
      flex: 0 0 80vw; /* default width */
      height: 75vh;
      border-radius: 0;
      overflow: hidden;
      background: #e2e8f0;
      scroll-snap-align: center;
      display: grid;
      place-items: center;
      cursor: zoom-in;
      transform: scale(0.94);
      transition: transform .25s ease, flex-basis .25s ease;
    }
    .card.is-active { transform: scale(1); z-index: 2; }
    .card.is-selected { flex-basis: 70vw; }

    .card img { width: 100%; height: 100%; object-fit: contain; object-position: center; display: block; }
    .card figcaption {
      position: absolute; left: .6rem; bottom: .6rem;
      background: rgba(15, 23, 42, .6);
      color: #fff; padding: .25rem .5rem; border-radius: 0; font-size: .8rem;
    }

    /* Arrow buttons */
    .arrow { position: absolute; top: 50%; transform: translateY(-50%);
      background: rgba(255,255,255,.95); border: 1px solid #e2e8f0; color: #0f172a;
      width: 42px; height: 42px; border-radius: 999px; display: grid; place-items: center;
      box-shadow: 0 6px 16px rgba(2,8,23,.18); cursor: pointer; user-select: none;
    }
    .arrow:hover { background: #fff; }
    .arrow--left { left: .75rem; }
    .arrow--right { right: .75rem; }

    /* Lightbox */
    .lightbox { position: fixed; inset: 0; z-index: 100; display: none; background: rgba(0,0,0,.85); }
    .lightbox[aria-hidden="false"] { display: block; }
    .lightbox__chrome {
      position: absolute; top: 0; left: 0; right: 0;
      display: flex; align-items: center; justify-content: space-between;
      padding: .75rem 1rem; color: #fff; z-index: 5;
    }
    .lb-btn { background: rgba(255,255,255,.15); color: #fff; border: 1px solid rgba(255,255,255,.3);
      padding: .45rem .7rem; border-radius: .6rem; cursor: pointer; margin-right: .4rem; }
    .lb-btn:hover { background: rgba(255,255,255,.25); }

    .lightbox__stage { position: absolute; inset: 48px 0 0 0; display: grid; place-items: center; }

    /* Lightbox viewport (80% of screen) */
    .lb-viewport {
      width: 80vw; height: 80vh;
      max-width: 1400px; max-height: calc(100vh - 80px);
      margin: 0 auto; position: relative; overflow: hidden;
      background: rgba(255,255,255,0.02);
      box-shadow: 0 20px 50px rgba(0,0,0,.4);
      outline: 1px solid rgba(255,255,255,0.08);
      touch-action: none;
    }

    .lb-img { will-change: transform; transform-origin: center center; max-width: none; user-select: none; -webkit-user-drag: none; box-shadow: 0 20px 40px rgba(0,0,0,.35); border-radius: 0; }
    /* Back-to-top button */
    .back-to-top {
      position: fixed; bottom: 1.25rem; right: 1.25rem;
      width: 52px; height: 52px; border-radius: 999px;
      background: var(--primary); color: #fff; border: none;
      display: grid; place-items: center; font-size: 20px;
      box-shadow: 0 10px 24px rgba(2,8,23,.25);
      z-index: 60; opacity: 0; pointer-events: none;
      transform: translateY(8px);
      transition: opacity .25s ease, transform .25s ease, box-shadow .25s ease;
    }
    .back-to-top.show { opacity: 1; pointer-events: auto; transform: translateY(0); }
    .back-to-top:hover { box-shadow: 0 14px 30px rgba(2,8,23,.32); }
    .back-to-top:focus-visible { outline: 3px solid rgba(255,255,255,.6); outline-offset: 2px; }
    /* Home button (highlighted) */
    .home-btn {
      display: inline-flex; align-items: center; justify-content: center;
      gap: .4rem; padding: .5rem .9rem; border-radius: 999px;
      background: #ffffff; color: var(--secondary); font-weight: 700;
      text-decoration: none; border: 2px solid rgba(255,255,255,.7);
      box-shadow: 0 8px 18px rgba(2,8,23,.25);
      transition: transform .2s ease, box-shadow .2s ease, background .2s ease;
      white-space: nowrap;
    }
    .home-btn:hover { transform: translateY(-1px); box-shadow: 0 12px 26px rgba(2,8,23,.32); }
    .home-btn:active { transform: translateY(0); }
    .home-btn:focus-visible { outline: 3px solid rgba(255,255,255,.85); outline-offset: 2px; }    @media (max-width: 700px) {
      .strip { padding: 0 3rem 3px; }
      .card { flex-basis: 90vw; height: 75vh; }
    }
  
    /* Scroll-reveal */
    .sr { opacity: 0; transform: translateY(18px); transition: transform .6s ease, opacity .6s ease; will-change: transform, opacity; }
    .sr.reveal { opacity: 1; transform: none; }
    @media (prefers-reduced-motion: reduce) { .sr { opacity: 1; transform: none !important; transition: none; } }
</style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="brand">NCR Construction - Gallery</div>
      <a href="index.html" class="home-btn" aria-label="Go to Home" title="Home">Home</a>
      <nav class="toc" aria-label="Categories">
        <a href="#carpentry">Carpentry</a>
        <a href="#painting">Painting</a>
        <a href="#deck">Deck</a>
        <a href="#furniture">Furniture</a>
        <a href="#pergolas-interiors">Pergolas, Sheds &amp; Interiors</a>
        <a href="#exteriors">Exterior Works &amp; Fences</a>
        <a href="#siding">Siding</a>
        <a href="#masonry-brick">Masonry / Brick</a>
        <a href="#roofing">Roofing</a>
        <a href="#metal-welding">Metal Welding</a>
        <a href="#rebar-frames">Rebar Frames</a>
      </nav>
    </div>
  </header>

  <main>
    <section id="carpentry">
      <div class="wrap">
        <div class="section-head">
          <h2 class="section-title">Carpentry</h2>
          <p class="section-sub">Framing, finish carpentry, and custom woodwork.</p>
        </div>
        <div class="strip" data-strip data-category="carpentry" data-label="Carpentry">
          <button class="arrow arrow--left" data-left aria-label="Previous">&lsaquo;</button>
          <div class="strip__scroller" data-scroller></div>
          <button class="arrow arrow--right" data-right aria-label="Next">&rsaquo;</button>
        </div>
      </div>
    </section>

    <section id="painting">
      <div class="wrap">
        <div class="section-head">
          <h2 class="section-title">Painting</h2>
          <p class="section-sub">Interiors, exteriors, and professional finishes.</p>
        </div>
        <div class="strip" data-strip data-category="painting" data-label="Painting">
          <button class="arrow arrow--left" data-left aria-label="Previous">&lsaquo;</button>
          <div class="strip__scroller" data-scroller></div>
          <button class="arrow arrow--right" data-right aria-label="Next">&rsaquo;</button>
        </div>
      </div>
    </section>

    <section id="deck">
      <div class="wrap">
        <div class="section-head">
          <h2 class="section-title">Deck</h2>
          <p class="section-sub">Build, repair, and maintenance for decks.</p>
        </div>
        <div class="strip" data-strip data-category="deck" data-label="Deck">
          <button class="arrow arrow--left" data-left aria-label="Previous">&lsaquo;</button>
          <div class="strip__scroller" data-scroller></div>
          <button class="arrow arrow--right" data-right aria-label="Next">&rsaquo;</button>
        </div>
      </div>
    </section>

    <section id="furniture">
      <div class="wrap">
        <div class="section-head">
          <h2 class="section-title">Furniture</h2>
          <p class="section-sub">Custom-built furniture and restorations.</p>
        </div>
        <div class="strip" data-strip data-category="furniture" data-label="Furniture">
          <button class="arrow arrow--left" data-left aria-label="Previous">&lsaquo;</button>
          <div class="strip__scroller" data-scroller></div>
          <button class="arrow arrow--right" data-right aria-label="Next">&rsaquo;</button>
        </div>
      </div>
    </section>

    <section id="pergolas-interiors">
      <div class="wrap">
        <div class="section-head">
          <h2 class="section-title">Pergolas, Sheds &amp; Interiors</h2>
          <p class="section-sub">Pergolas, sheds, gazebos; doors, drywall, arches, wall framing, windows, electrical fixtures, and custom ceilings.</p>
        </div>
        <div class="strip" data-strip data-category="interiors" data-label="Pergolas, Sheds & Interiors">
          <button class="arrow arrow--left" data-left aria-label="Previous">&lsaquo;</button>
          <div class="strip__scroller" data-scroller></div>
          <button class="arrow arrow--right" data-right aria-label="Next">&rsaquo;</button>
        </div>
      </div>
    </section>

    <section id="exteriors">
      <div class="wrap">
        <div class="section-head">
          <h2 class="section-title">Exterior Works &amp; Fences</h2>
          <p class="section-sub">Porch renovations, concrete, stairs, railings, doors, and fences.</p>
        </div>
        <div class="strip" data-strip data-category="exteriors" data-label="Exteriors & Fences">
          <button class="arrow arrow--left" data-left aria-label="Previous">&lsaquo;</button>
          <div class="strip__scroller" data-scroller></div>
          <button class="arrow arrow--right" data-right aria-label="Next">&rsaquo;</button>
        </div>
      </div>
    </section>

    <section id="siding">
      <div class="wrap">
        <div class="section-head">
          <h2 class="section-title">Siding</h2>
          <p class="section-sub">Installation and replacement of siding systems.</p>
        </div>
        <div class="strip" data-strip data-category="siding" data-label="Siding">
          <button class="arrow arrow--left" data-left aria-label="Previous">&lsaquo;</button>
          <div class="strip__scroller" data-scroller></div>
          <button class="arrow arrow--right" data-right aria-label="Next">&rsaquo;</button>
        </div>
      </div>
    </section>

    <section id="masonry-brick">
      <div class="wrap">
        <div class="section-head">
          <h2 class="section-title">Masonry / Brick</h2>
          <p class="section-sub">Repairs, renovations, and replacements.</p>
        </div>
        <div class="strip" data-strip data-category="masonry" data-label="Masonry / Brick">
          <button class="arrow arrow--left" data-left aria-label="Previous">&lsaquo;</button>
          <div class="strip__scroller" data-scroller></div>
          <button class="arrow arrow--right" data-right aria-label="Next">&rsaquo;</button>
        </div>
      </div>
    </section>

    <section id="roofing">
      <div class="wrap">
        <div class="section-head">
          <h2 class="section-title">Roofing</h2>
          <p class="section-sub">Shingles and metal roofing — installation and repairs.</p>
        </div>
        <div class="strip" data-strip data-category="roofing" data-label="Roofing">
          <button class="arrow arrow--left" data-left aria-label="Previous">&lsaquo;</button>
          <div class="strip__scroller" data-scroller></div>
          <button class="arrow arrow--right" data-right aria-label="Next">&rsaquo;</button>
        </div>
      </div>
    </section>

    <section id="metal-welding">
      <div class="wrap">
        <div class="section-head">
          <h2 class="section-title">Metal Welding</h2>
          <p class="section-sub">Simple welding jobs and light fabrication.</p>
        </div>
        <div class="strip" data-strip data-category="welding" data-label="Metal Welding">
          <button class="arrow arrow--left" data-left aria-label="Previous">&lsaquo;</button>
          <div class="strip__scroller" data-scroller></div>
          <button class="arrow arrow--right" data-right aria-label="Next">&rsaquo;</button>
        </div>
      </div>
    </section>

    <section id="rebar-frames">
      <div class="wrap">
        <div class="section-head">
          <h2 class="section-title">Rebar Frames</h2>
          <p class="section-sub">Metal frameworks prepared for concrete foundations.</p>
        </div>
        <div class="strip" data-strip data-category="rebar" data-label="Rebar Frames">
          <button class="arrow arrow--left" data-left aria-label="Previous">&lsaquo;</button>
          <div class="strip__scroller" data-scroller></div>
          <button class="arrow arrow--right" data-right aria-label="Next">&rsaquo;</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Lightbox for zoom/pan -->
  <div class="lightbox" id="lightbox" aria-hidden="true" role="dialog" aria-label="Image viewer">
    <div class="lightbox__chrome">
      <div>
        <button class="lb-btn" data-zoom-in>Zoom +</button>
        <button class="lb-btn" data-zoom-out>Zoom -</button>
        <button class="lb-btn" data-zoom-reset>Reset</button>
      </div>
      <button class="lb-btn" data-close aria-label="Close (Esc)">Close &times;</button>
    </div>
    <div class="lightbox__stage" id="lb-stage">
      <div class="lb-viewport" id="lb-viewport">
        <img class="lb-img" id="lb-img" alt="Zoomed image" />
      </div>
    </div>
  </div>
  <button id="backToTop" class="back-to-top" aria-label="Back to top" title="Back to top">?</button>  <script>
    // Populate 20 images per gallery using Picsum seeds
    function imageUrl(cat, i) {
      return `https://picsum.photos/seed/${cat}-${i}/1600/1000`;
    }

    function buildGallery(scroller, cat, label) {
      scroller.innerHTML = '';
      for (let i = 1; i <= 20; i++) {
        const fig = document.createElement('figure');
        fig.className = 'card';
        const img = document.createElement('img');
        img.loading = 'lazy';
        img.decoding = 'async';
        img.src = imageUrl(cat, i);
        img.alt = `${label} - Photo ${i}`;
        const cap = document.createElement('figcaption');
        cap.textContent = `${label} ${i}`;
        fig.appendChild(img); fig.appendChild(cap);
        scroller.appendChild(fig);
      }
    }

    // Make scroller infinite by cloning head/tail
    function makeInfinite(scroller) {
      const originals = Array.from(scroller.children);
      if (!originals.length) return;
      const before = originals.map(n => n.cloneNode(true));
      const after = originals.map(n => n.cloneNode(true));
      before.forEach(n => scroller.insertBefore(n, scroller.firstChild));
      after.forEach(n => scroller.appendChild(n));

      const cs = getComputedStyle(scroller);
      const gapPx = parseFloat(cs.gap || cs.columnGap || 0) || 0;
      function measureUnit() {
        let unit = 0;
        originals.forEach((el, idx) => {
          unit += el.getBoundingClientRect().width;
          if (idx < originals.length - 1) unit += gapPx;
        });
        return unit;
      }
      let unit = measureUnit();
      scroller._unit = unit;
      scroller.style.scrollBehavior = 'auto';
      scroller.scrollLeft = unit + 1; // center on middle set
      scroller.style.scrollBehavior = '';

      scroller.addEventListener('scroll', () => {
        const left = scroller.scrollLeft;
        if (left < unit * 0.25) {
          scroller.style.scrollBehavior = 'auto';
          scroller.scrollLeft = left + unit;
          scroller.style.scrollBehavior = '';
        } else if (left > unit * 1.75) {
          scroller.style.scrollBehavior = 'auto';
          scroller.scrollLeft = left - unit;
          scroller.style.scrollBehavior = '';
        }
      });

      window.addEventListener('resize', () => {
        const prev = unit;
        unit = measureUnit();
        scroller._unit = unit;
        const ratio = scroller.scrollLeft / prev;
        scroller.style.scrollBehavior = 'auto';
        scroller.scrollLeft = ratio * unit;
        scroller.style.scrollBehavior = '';
      });
    }

    // Arrow controls
    function wireArrows(strip) {
      const scroller = strip.querySelector('[data-scroller]');
      const left = strip.querySelector('[data-left]');
      const right = strip.querySelector('[data-right]');
      const step = () => Math.max(360, Math.min(scroller.clientWidth * 0.95, 1000));
      left.addEventListener('click', () => scroller.scrollBy({ left: -step(), behavior: 'smooth' }));
      right.addEventListener('click', () => scroller.scrollBy({ left: +step(), behavior: 'smooth' }));
    }

    // Build all galleries
    document.querySelectorAll('[data-strip]').forEach(strip => {
      const scroller = strip.querySelector('[data-scroller]');
      const cat = strip.getAttribute('data-category');
      const label = strip.getAttribute('data-label');
      buildGallery(scroller, cat, label);
      wireArrows(strip);
      requestAnimationFrame(() => makeInfinite(scroller));
    });

    // Lightbox with contained zoom
    const lb = document.getElementById('lightbox');
    const lbImg = document.getElementById('lb-img');
    const stage = document.getElementById('lb-stage');
    const viewport = document.getElementById('lb-viewport');
    // Back-to-top button
    const backBtn = document.getElementById('backToTop');
    function updateBackBtnVisibility() {
      const show = window.scrollY > 400 && (!lb || lb.getAttribute('aria-hidden') !== 'false');
      if (show) backBtn.classList.add('show'); else backBtn.classList.remove('show');
    }
    window.addEventListener('scroll', updateBackBtnVisibility, { passive: true });
    document.addEventListener('DOMContentLoaded', updateBackBtnVisibility);
    backBtn.addEventListener('click', (e) => { e.preventDefault(); window.scrollTo({ top: 0, behavior: 'smooth' }); });

    let scale = 1, minScale = 1, maxScale = 5;
    let baseW = 0, baseH = 0;
    let pos = { x: 0, y: 0 };
    let start = { x: 0, y: 0 };
    let startPos = { x: 0, y: 0 };
    const active = new Map(); // pointerId -> {x,y}

    function applyTransform() {
      const frameW = viewport.clientWidth || 1;
      const frameH = viewport.clientHeight || 1;
      const imgW = (baseW || frameW) * scale;
      const imgH = (baseH || frameH) * scale;
      const allowX = Math.max(0, (imgW - frameW) / 2);
      const allowY = Math.max(0, (imgH - frameH) / 2);
      if (pos.x > allowX) pos.x = allowX; if (pos.x < -allowX) pos.x = -allowX;
      if (pos.y > allowY) pos.y = allowY; if (pos.y < -allowY) pos.y = -allowY;
      lbImg.style.transform = `translate(${pos.x}px, ${pos.y}px) scale(${scale})`;
    }

    function openLightbox(src, alt) {
      lbImg.src = src; lbImg.alt = alt || 'Image';
      lb.setAttribute('aria-hidden', 'false');
      scale = 1; pos = { x: 0, y: 0 };
      baseW = viewport.clientWidth; baseH = viewport.clientHeight;
      applyTransform();
    }

    function closeLightbox() {
      lb.setAttribute('aria-hidden', 'true');
      lbImg.src = '';
      active.clear();
    }

    function clamp(val, min, max) { return Math.max(min, Math.min(max, val)); }

    // Card click: first selects (narrows), second opens lightbox
    // Card click: open lightbox on single click
document.addEventListener('click', (e) => {
  const img = e.target.closest('.card img');
  if (!img) return;
  openLightbox(img.src, img.alt);
});

    // Controls
    document.querySelector('[data-close]').addEventListener('click', closeLightbox);
    document.querySelector('[data-zoom-in]').addEventListener('click', () => { scale = clamp(scale * 1.2, minScale, maxScale); applyTransform(); });
    document.querySelector('[data-zoom-out]').addEventListener('click', () => { scale = clamp(scale / 1.2, minScale, maxScale); applyTransform(); });
    document.querySelector('[data-zoom-reset]').addEventListener('click', () => { scale = 1; pos = { x: 0, y: 0 }; applyTransform(); });

    // Close on background click or Esc / Right-click
    lb.addEventListener('click', (e) => { if (e.target === lb) closeLightbox(); });
    lb.addEventListener('contextmenu', (e) => { e.preventDefault(); closeLightbox(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeLightbox(); });

    // Pointer events for pan + pinch (inside viewport)
    viewport.addEventListener('pointerdown', (e) => {
      if (lb.getAttribute('aria-hidden') === 'true') return;
      viewport.setPointerCapture(e.pointerId);
      active.set(e.pointerId, { x: e.clientX, y: e.clientY });
      startPos = { ...pos };
      start = { x: e.clientX, y: e.clientY };
    });
    viewport.addEventListener('pointermove', (e) => {
      if (!active.has(e.pointerId)) return;
      active.set(e.pointerId, { x: e.clientX, y: e.clientY });
      if (active.size === 1) {
        if (scale > 1) {
          const dx = e.clientX - start.x;
          const dy = e.clientY - start.y;
          pos = { x: startPos.x + dx, y: startPos.y + dy };
          applyTransform();
        }
      } else if (active.size === 2) {
        const pts = Array.from(active.values());
        const dx = pts[1].x - pts[0].x; const dy = pts[1].y - pts[0].y;
        const dist = Math.hypot(dx, dy);
        if (!viewport._baseDist) { viewport._baseDist = dist; viewport._baseScale = scale; }
        const next = clamp(viewport._baseScale * (dist / viewport._baseDist), minScale, maxScale);
        const cx = (pts[0].x + pts[1].x) / 2; const cy = (pts[0].y + pts[1].y) / 2;
        const factor = next / scale;
        pos = { x: (pos.x - cx) * factor + cx, y: (pos.y - cy) * factor + cy };
        scale = next; applyTransform();
      }
    });
    viewport.addEventListener('pointerup', (e) => { active.delete(e.pointerId); if (active.size < 2) { viewport._baseDist = null; viewport._baseScale = null; } });
    viewport.addEventListener('pointercancel', (e) => { active.delete(e.pointerId); viewport._baseDist = null; viewport._baseScale = null; });

    // Wheel zoom (desktop)
    viewport.addEventListener('wheel', (e) => {
      if (lb.getAttribute('aria-hidden') === 'true') return;
      e.preventDefault();
      const delta = -e.deltaY; // up = zoom in
      const zoom = Math.exp(delta * 0.0015);
      const next = clamp(scale * zoom, minScale, maxScale);
      const cx = e.clientX; const cy = e.clientY;
      const factor = next / scale;
      pos = { x: (pos.x - cx) * factor + cx, y: (pos.y - cy) * factor + cy };
      scale = next; applyTransform();
    }, { passive: false });

    // Single click in viewport: recenter when zoomed
    viewport.addEventListener('click', (e) => {
      if (lb.getAttribute('aria-hidden') === 'true') return;
      if (scale <= 1) return;
      const rect = viewport.getBoundingClientRect();
      const cx = rect.left + rect.width / 2;
      const cy = rect.top + rect.height / 2;
      pos = { x: pos.x + (cx - e.clientX) / scale, y: pos.y + (cy - e.clientY) / scale };
      applyTransform();
    });

    // Double-click: toggle between max zoom and original
    viewport.addEventListener('dblclick', (e) => {
      e.preventDefault();
      if (lb.getAttribute('aria-hidden') === 'true') return;
      const cx = e.clientX; const cy = e.clientY;
      if (scale < (maxScale - 0.01)) {
        const next = maxScale; const factor = next / scale;
        pos = { x: (pos.x - cx) * factor + cx, y: (pos.y - cy) * factor + cy };
        scale = next;
      } else {
        scale = 1; pos = { x: 0, y: 0 };
      }
      applyTransform();
    });

    // Highlight centered slide
    function markActiveFor(scroller) {
      const cards = scroller.querySelectorAll('.card');
      if (!cards.length) return;
      let best = null, bestDist = Infinity;
      const viewportCenter = window.innerWidth / 2;
      cards.forEach(card => {
        const r = card.getBoundingClientRect();
        const center = r.left + r.width / 2;
        const d = Math.abs(center - viewportCenter);
        if (d < bestDist) { bestDist = d; best = card; }
      });
      cards.forEach(c => c.classList.remove('is-active'));
      if (best) best.classList.add('is-active');
    }

    function setupActiveHighlight(scroller) {
      const onScroll = () => {
        if (scroller._raf) return;
        scroller._raf = requestAnimationFrame(() => { markActiveFor(scroller); scroller._raf = null; });
      };
      scroller.addEventListener('scroll', onScroll, { passive: true });
      markActiveFor(scroller);
    }

    document.querySelectorAll('[data-scroller]').forEach(setupActiveHighlight);
    window.addEventListener('resize', () => { document.querySelectorAll('[data-scroller]').forEach(markActiveFor); });

    // Keyboard navigation: Left/Right arrows select previous/next card
    (function enableKeyboardNav(){
      function currentScroller(){
        const scrollers = Array.from(document.querySelectorAll('[data-scroller]'));
        if (!scrollers.length) return null;
        const midY = window.innerHeight / 2;
        let best = null, bestDist = Infinity;
        scrollers.forEach(s => {
          const r = s.getBoundingClientRect();
          if (r.top <= midY && r.bottom >= midY) { best = s; bestDist = 0; }
          else {
            const cy = r.top + r.height / 2;
            const d = Math.abs(cy - midY);
            if (d < bestDist) { best = s; bestDist = d; }
          }
        });
        return best || null;
      }
      function nearestCard(scroller){
        const cards = Array.from(scroller.querySelectorAll('.card'));
        if (!cards.length) return { cards, idx: -1 };
        const selected = scroller.querySelector('.card.is-selected') || scroller.querySelector('.card.is-active');
        if (selected) return { cards, idx: cards.indexOf(selected) };
        const midX = window.innerWidth / 2;
        let bestIdx = 0, bestDist = Infinity;
        cards.forEach((c, i) => {
          const r = c.getBoundingClientRect();
          const cx = r.left + r.width / 2;
          const d = Math.abs(cx - midX);
          if (d < bestDist) { bestDist = d; bestIdx = i; }
        });
        return { cards, idx: bestIdx };
      }
      function selectByIndex(scroller, cards, idx){
        if (idx < 0 || idx >= cards.length) return;
        scroller.querySelectorAll('.card.is-selected').forEach(c => c.classList.remove('is-selected'));
        const card = cards[idx];
        card.classList.add('is-selected');
        card.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
        if (typeof markActiveFor === 'function') requestAnimationFrame(() => markActiveFor(scroller));
      }
      document.addEventListener('keydown', (e) => {
        if (lb && lb.getAttribute('aria-hidden') === 'false') return; // ignore when lightbox open
        if (e.key !== 'ArrowRight' && e.key !== 'ArrowLeft') return;
        const scroller = currentScroller(); if (!scroller) return;
        const { cards, idx } = nearestCard(scroller); if (!cards.length) return;
        e.preventDefault();
        const delta = e.key === 'ArrowRight' ? 1 : -1;
        const nextIdx = (idx + delta + cards.length) % cards.length;
        selectByIndex(scroller, cards, nextIdx);
      });
    })();

    // Resize: recompute base dims for contained viewport
    window.addEventListener('resize', () => {
      if (lb.getAttribute('aria-hidden') === 'false') {
        baseW = viewport.clientWidth; baseH = viewport.clientHeight;
        applyTransform();
      }
    });
  </script>

  <script> (function(){ document.querySelectorAll('.section-head, .strip').forEach((el,i)=>{ el.classList.add('sr'); el.style.transitionDelay=(i*60)+'ms'; }); const io=new IntersectionObserver((es)=>{ es.forEach(e=>{ if(e.isIntersecting){ e.target.classList.add('reveal'); io.unobserve(e.target);} }); },{threshold:0.15, rootMargin:'0px 0px -5% 0px'}); document.querySelectorAll('.sr').forEach(el=>io.observe(el)); })(); </script>
</body>
</html>














